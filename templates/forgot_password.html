{% extends "base.html" %}
{% load static tailwind_tags %}

{% block content %}
<div class="relative isolate max-md:px-2 md:px-6 py-32 lg:px-8 flex flex-col justify-center items-center">
    <div class="flex flex-col items-center gap-1 mb-6 w-full md:pt-40">
        <h1 class="max-md:text-xl md:text-3xl font-semibold text-white text-center">Reset your Password</h1>
        <hr class="w-[90%] md:w-[50%]">
    </div>

    <div id="registration-form" class="mt-10 sm:mx-auto w-full md:max-w-[30%] px-4 h-[40vh]">

        <!-- Step 1: Email -->
        <form id="step1" class="space-y-4 w-full" onsubmit="sendOTP(event)">
            <div>
                <label for="email" class="block text-sm font-medium text-white/90">Enter your email for verification</label>
                <div class="mt-2">
                    <input id="email" type="email" name="email" placeholder="Enter your email" required class="block w-full rounded-md bg-white/10 px-3 py-1.5 text-white/90 placeholder:text-white/30 border-white/10 focus:border-white/10 outline-none" />
                </div>
            </div>
            <div class="mt-10">
                <p id="step1-error" class="text-red-400 text-sm hidden text-center mb-4"></p>
                <button id="send_otp_button" type="submit" class="flex w-full justify-center rounded-md bg-pink-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-pink-500 cursor-pointer">
                    <span class="hidden spinner border-white border-2 border-t-transparent animate-spin rounded-full w-4 h-4 mr-2"></span>
                    Send OTP
                </button>
            </div>
        </form>

        <!-- Step 2: OTP -->
        <form id="step2" class="space-y-4 w-full hidden" onsubmit="verifyOTP(event)">
            <div>
                <label for="otp" class="block text-sm font-medium text-white/90">Enter OTP</label>
                <div class="mt-2">
                    <input type="text" name="otp" id="otp" placeholder="Enter OTP" required class="block w-full rounded-md bg-white/10 px-3 py-1.5 text-white/90 placeholder:text-white/30 text-center tracking-widest border-white/10 outline-none" />
                </div>
            </div>
            <div class="mt-10">
                <p id="step2-error" class="text-red-400 text-sm hidden text-center mb-4"></p>
                <div class="flex justify-between items-center gap-3">
                    <button type="button" onclick="goToStep1()" class="px-3 py-1.5 bg-pink-600 text-white flex justify-center items-center cursor-pointer rounded-md">
                        <i class='bx bx-arrow-left-stroke text-xl'></i>
                    </button>
                    <button id="verify_button" type="submit" class="flex w-full justify-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-emerald-500 cursor-pointer">
                        <span class="hidden spinner border-white border-2 border-t-transparent animate-spin rounded-full w-4 h-4 mr-2"></span>
                        Verify OTP
                    </button>
                </div>
            </div>
        </form>

        <!-- Step 3: Reset Password -->
        <form id="step3" class="space-y-4 w-full hidden" onsubmit="resetPassword(event)">
            
            <div>
                <label for="new_password" class="block text-sm font-medium text-white/90">New Password</label>
                <div class="mt-2">
                    <input type="password" name="password" id="new_password" required class="block w-full rounded-md bg-white/10 px-3 py-1.5 text-white/90 placeholder:text-white/30 border-white/10 outline-none" />
                </div>
            </div>

            <div>
                <label for="confirm_password" class="block text-sm font-medium text-white/90">Confirm Password</label>
                <div class="mt-2">
                    <input type="password" name="confirm_password" id="confirm_password" required class="block w-full rounded-md bg-white/10 px-3 py-1.5 text-white/90 placeholder:text-white/30 border-white/10 outline-none" />
                </div>
            </div>

            <div class="mt-10">
                <p id="step3-error" class="text-red-400 text-sm hidden text-center mb-4"></p>
                <div class="flex justify-between items-center gap-3">
                    <button type="button" onclick="goToStep1()" class="px-3 py-1.5 bg-pink-600 text-white flex justify-center items-center cursor-pointer rounded-md">
                        <i class='bx bx-arrow-left-stroke text-xl'></i>
                    </button>
                    <button id="reset_button" type="submit" class="flex w-full justify-center rounded-md bg-pink-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-pink-500 cursor-pointer">
                        <span class="hidden spinner border-white border-2 border-t-transparent animate-spin rounded-full w-4 h-4 mr-2"></span>
                        Reset
                    </button>
                </div>
            </div>
        </form>

        <p id="success" class="text-green-600 mt-20 hidden text-center"></p>
    </div>
</div>

<script>
    document.querySelectorAll("#step2 input, #step2 input, #step3 input").forEach(el => el.value = "");
    function showError(message, targetId = "step1-error") {
        const box = document.getElementById(targetId);
        box.textContent = message;
        box.classList.remove("hidden");
        setTimeout(() => { box.classList.add("hidden"); box.textContent = ""; }, 3000);
    }

    function showSuccess(message) {
        const success = document.getElementById("success");
        success.textContent = message;
        success.classList.remove("hidden");
    }

    function showLoading(buttonId) {
        const btn = document.getElementById(buttonId);
        btn.disabled = true;
        btn.classList.add("opacity-70", "cursor-wait");
        btn.querySelector(".spinner").classList.remove("hidden");

        document.querySelectorAll("input").forEach(el => {
            el.disabled = true;
            el.classList.add("opacity-70", "cursor-wait");
        });
    }

    function hideLoading(buttonId) {
        const btn = document.getElementById(buttonId);
        btn.disabled = false;
        btn.classList.remove("opacity-70", "cursor-wait");
        btn.querySelector(".spinner").classList.add("hidden");

        document.querySelectorAll("input").forEach(el => {
            el.disabled = false;
            el.classList.remove("opacity-70", "cursor-wait");
        });
    }

    function goToStep1() {
        document.getElementById("step1").classList.remove("hidden");
        document.getElementById("step2").classList.add("hidden");
        document.getElementById("step3").classList.add("hidden");
        hideLoading("send_otp_button");

        document.querySelectorAll("#step2 input, #step3 input").forEach(el => el.value = "");
    }

    function sendOTP(e) {
        e.preventDefault();
        const email = document.getElementById("email").value;
        if (!email) return showError("Please enter email.", "step1-error");

        showLoading("send_otp_button");

        fetch("{% url 'forgot_password' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: new URLSearchParams({ email })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                document.getElementById("step1").classList.add("hidden");
                document.getElementById("step2").classList.remove("hidden");
                showSuccess(data.message);
            } else {
                showError(data.message, "step1-error");
            }
        })
        .finally(() => hideLoading("send_otp_button"));
    }

    function verifyOTP(e) {
        e.preventDefault();
        const otp = document.getElementById("otp").value;
        showLoading("verify_button");

        fetch("{% url 'verify_forgot_otp' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ otp })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "verified") {
                document.getElementById("step2").classList.add("hidden");
                document.getElementById("step3").classList.remove("hidden");
            } else {
                showError("Invalid OTP!", "step2-error");
            }
        })
        .catch(() => showError("Something went wrong.", "step2-error"))
        .finally(() => hideLoading("verify_button"));
    }

    function resetPassword(e) {
        e.preventDefault();
        const new_password = document.getElementById("new_password").value;
        const confirm_password = document.getElementById("confirm_password").value;

        showLoading("reset_button");

        fetch("{% url 'reset_password' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: new URLSearchParams({ new_password, confirm_password })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                showSuccess(data.message);
                setTimeout(() => window.location.href = "/signin/", 2000);
            } else {
                showError(data.message, "step3-error");
            }
        })
        .finally(() => hideLoading("reset_button"));
    }
</script>
{% endblock %}
