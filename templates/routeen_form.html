{% extends 'base.html' %}
{% block title %}{{ is_edit|yesno:"Edit Routeen,Create Routeen" }}{% endblock %}

{% block content %}
<div class="px-4 md:px-6 py-20 md:py-32 text-white">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-xl md:text-2xl font-bold mb-6 text-center">
            {{ is_edit|yesno:"Edit Routeen,Create Routeen" }}
        </h1>

        <form method="POST" enctype="multipart/form-data" class="space-y-4 bg-white/10 p-6 rounded-lg text-xs md:text-sm">
            {% csrf_token %}

            <!-- University -->
            <div class="w-full">
                <label for="university" class="block text-sm font-medium text-white/90">University</label>
                <div class="mt-2">
                    {% if request.user.is_CR %}
                        <input type="hidden" name="university" value="{{ request.user.university_id }}">
                        <input type="text" disabled value="{{ request.user.university.name }}"
                            class="block w-full rounded-md bg-white/10 px-3 py-2 text-white/80 border-white/10 outline-none">
                    {% else %}
                        <select name="university" id="university" required
                            class="block w-full rounded-md bg-white/10 px-1 py-2 text-xs md:text-sm text-white/90 sm:text-sm border-white/10 focus:border-white/10 outline-none focus:outline-none focus:bg-gray-900">
                            <option value="" disabled {% if not routeen.university_id %}selected{% endif %}>Select Your University</option>
                            {% for university in universities %}
                                <option value="{{ university.id }}" {% if routeen.university_id == university.id %}selected{% endif %}>
                                    {{ university.name }}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>
            </div>

            <div class="flex max-md:flex-col justify-between gap-3">
                <!-- Department -->
                <div class="w-full md:w-2/3">
                    <label for="department" class="block text-sm font-medium text-white/90">Department</label>
                    <div class="mt-2">
                        {% if request.user.is_CR %}
                            <input type="hidden" name="department" value="{{ request.user.department_id }}">
                            <input type="text" disabled value="{{ request.user.department.name }}"
                                class="block w-full rounded-md bg-white/10 px-3 py-2 text-white/80 border-white/10 outline-none">
                        {% else %}
                            <select name="department" id="department" required {% if not is_edit %}disabled{% endif %}
                                class="block w-full rounded-md bg-white/10 px-1 py-2 text-xs md:text-sm text-white/90 border-white/10 focus:border-white/10 outline-none focus:outline-none focus:bg-gray-900">
                                {% if is_edit and departments %}
                                    <option disabled>Select a department</option>
                                    {% for dept in departments %}
                                        <option value="{{ dept.id }}" {% if routeen.department_id == dept.id %}selected{% endif %}>
                                            {{ dept.name }}
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled selected>Select university first</option>
                                {% endif %}
                            </select>
                        {% endif %}
                    </div>
                </div>

                <!-- Batch -->
                <div class="w-full md:w-1/3">
                    <label for="batch" class="block text-sm font-medium text-white/90">Batch</label>
                    <div class="mt-2">
                        {% if request.user.is_CR %}
                            <input type="hidden" name="batch" value="{{ request.user.batch_id }}">
                            <input type="text" disabled value="{{ request.user.batch.name }}"
                                class="block w-full rounded-md bg-white/10 px-3 py-2 text-white/80 border-white/10 outline-none">
                        {% else %}
                            <select name="batch" id="batch" required {% if not is_edit %}disabled{% endif %}
                                class="block w-full rounded-md bg-white/10 px-1 py-2 text-xs md:text-sm text-white/90 border-white/10 focus:border-white/10 outline-none focus:outline-none focus:bg-gray-900">
                                {% if is_edit and batches %}
                                    <option disabled>Select a batch</option>
                                    {% for b in batches %}
                                        <option value="{{ b.id }}" {% if routeen.batch_id == b.id %}selected{% endif %}>{{ b.name }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled selected>Select department first</option>
                                {% endif %}
                            </select>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Title -->
            <div class="w-full">
                <label for="title" class="block text-sm font-medium text-white/90">Title</label>
                <div class="mt-2">
                    <input type="text" name="title" id="title" autocomplete="title" required
                        value="{{ routeen.title|default:'' }}"
                        class="block w-full rounded-md bg-white/10 px-3 py-1.5 text-base text-white/90 placeholder:text-white/30 sm:text-sm/6 border-white/10 focus:border-white/10 outline-none focus:outline-none" />
                </div>
            </div>

            <!-- PDF Upload -->
            <div class="w-full mt-4">
                <label class="block text-sm font-medium text-white/90 mb-2">Upload PDF File</label>

                <!-- Dropzone -->
                <div id="pdfUploadBox"
                    class="relative flex items-center justify-center border-2 border-dashed border-white/20 rounded-xl p-5 bg-white/5 hover:bg-white/10 transition cursor-pointer {% if is_edit and routeen.pdf_file %}hidden{% endif %}">
                    <input type="file" name="pdf_file" id="pdf_file" accept="application/pdf" onchange="showFileName(this)"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                    <div class="text-center text-white/70 z-0 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 mb-2 text-white/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4" />
                        </svg>
                        <p class="text-sm">Click or drag & drop your PDF here (1 file)</p>
                    </div>
                </div>

                <!-- File Display -->
                <div id="fileNameDisplay"
                    class="mt-3 hidden bg-white/10 border border-white/10 text-white/80 px-4 py-2 rounded-lg flex items-center justify-between gap-4">
                    <span id="selectedFileName" class="truncate w-full"></span>
                    <button type="button" onclick="clearFile()" class="text-red-400 hover:text-red-300 text-sm">Remove</button>
                </div>

                {% if is_edit and routeen.pdf_file %}
                    <div id="existingFileSection" class="mt-3 bg-white/10 border border-white/10 text-white/80 px-4 py-2 rounded-lg flex items-center justify-between gap-4">
                        <span class="truncate w-full">
                            Current File:
                            <a href="{{ routeen.pdf_file.url }}" class="underline text-blue-400 hover:text-blue-300" target="_blank">View PDF</a>
                        </span>
                        <button type="button" onclick="removeExistingFile()" class="text-red-400 hover:text-red-300 text-sm">Remove</button>
                    </div>
                    <!-- Hidden field to keep track -->
                    <input type="hidden" name="remove_existing_file" id="remove_existing_file" value="0">
                {% endif %}
            </div>

            <!-- Submit -->
            <div class="flex justify-center w-full">
                <button type="submit" class="bg-pink-500/60 hover:bg-pink-600/60 w-2/3 py-2 rounded text-white">
                    {{ is_edit|yesno:"Update,Create" }}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- File Handling Script -->
<script>
    function showFileName(input) {
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const selectedFileName = document.getElementById('selectedFileName');
        const uploadBox = document.getElementById('pdfUploadBox');

        if (input.files.length === 1 && input.files[0].type === "application/pdf") {
            selectedFileName.textContent = input.files[0].name;
            fileNameDisplay.classList.remove('hidden');
            uploadBox.classList.add('hidden');
        } else {
            alert("Please select a single PDF file.");
            clearFile();
        }
    }

    function clearFile() {
        const fileInput = document.getElementById('pdf_file');
        fileInput.value = "";
        document.getElementById('fileNameDisplay').classList.add('hidden');
        document.getElementById('pdfUploadBox').classList.remove('hidden');
    }

    function removeExistingFile() {
        const existingSection = document.getElementById('existingFileSection');
        const uploadBox = document.getElementById('pdfUploadBox');

        existingSection.style.display = 'none';
        uploadBox.classList.remove('hidden');

        // mark for backend to delete old file
        document.getElementById('remove_existing_file').value = "1";
    }
</script>

<!-- University > Department > Batch Ajax -->
<script>
    document.getElementById('university').addEventListener('change', function () {
        const universityId = this.value;
        const departmentSelect = document.getElementById('department');
        departmentSelect.innerHTML = '<option disabled selected>Loading...</option>';
        departmentSelect.disabled = true;

        fetch(`/ajax/get-department/${universityId}/`)
            .then(response => response.json())
            .then(data => {
                departmentSelect.innerHTML = '<option disabled selected>Select a department</option>';
                data.department.forEach(department => {
                    const option = document.createElement('option');
                    option.value = department.id;
                    option.textContent = department.name;
                    departmentSelect.appendChild(option);
                });
                departmentSelect.disabled = false;
                document.getElementById('batch').disabled = true;
            })
            .catch(err => {
                departmentSelect.innerHTML = '<option disabled selected>Failed to load</option>';
                console.error(err);
            });
    });

    document.getElementById('department').addEventListener('change', function () {
        const departmentId = this.value;
        const batchSelect = document.getElementById('batch');
        batchSelect.innerHTML = '<option disabled selected>Loading...</option>';
        batchSelect.disabled = true;

        fetch(`/ajax/get-batches/${departmentId}/`)
            .then(response => response.json())
            .then(data => {
                batchSelect.innerHTML = '<option disabled selected>Select a batch</option>';
                data.batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch.id;
                    option.textContent = batch.name;
                    batchSelect.appendChild(option);
                });
                batchSelect.disabled = false;
            })
            .catch(err => {
                batchSelect.innerHTML = '<option disabled selected>Failed to load</option>';
                console.error(err);
            });
    });
</script>
{% endblock %}
